<link rel="stylesheet" href="#resources('css/datepicker.css')" />
<div id="content">
  <div id="content-header">
    <div id="breadcrumb"> <a href="#springUrl('/')" title="回到首页" class="tip-bottom"><i class="icon-home"></i> 首页</a><a href="javascript:;" class="current">涨停板</a> </div>
  </div>
  <div class="container-fluid">
    <div class="row-fluid">
      <div class="span12">
        <div class="widget-box">
          <div class="widget-title"> <span class="icon"><i class="icon-th"></i></span>
            <h5>涨停统计</h5>
          </div>
		  <div class="widget-content nopadding">
			<form id="searchForm" action="#springUrl('/zt/statis')" method="post" class="form-horizontal">
                <div class="search_option">
					<div>
                        <label>开始</label>
						<div data-date="${startDate}" class="input-append date datepicker">
							<input type="text" id="startDate" name="startDate" value="$!{startDate}" data-date-format="yyyy-mm-dd" class="span11" />
							<span class="add-on"><i class="icon-th"></i></span> 
						</div>
					</div>
					<div>
                        <label>截止</label>
						<div data-date="${endDate}" class="input-append date datepicker">
							<input type="text" id="endDate" name="endDate" value="$!{endDate}" data-date-format="yyyy-mm-dd" class="span11" />
							<span class="add-on"><i class="icon-th"></i></span> 
						</div>
					</div>
                    <div>
                        <button id="ztSearch" type="button"  class="btn btn-success">搜索</button>
                    </div>
                </div>
			</form>
          </div>
          <div class="widget-content">
            <table class="table table-bordered table-striped">
              <thead>
                <tr id="statis-col-name"></tr>
              </thead>
              <tbody id="statis-content">
              </tbody>
             </table>
			</div>
          </div>
        </div>
    </div>
  </div>
</div>
$!{tokenTool.enableAjaxToken()}
<script src="#resources('js/bootstrap-datepicker.js')"></script>
<script type="text/javascript">
	$(function(){
		$("#ztSearch").click(function(){
			var len = 0;
			jQuery.post("#springUrl('/zt/statis')",$("#searchForm").serialize(),function(result){
				if(result.success){
					$("#statis-content").html("");
					var dateList = result.records.dateList;
					var lbMap = result.records.lbMap;
					showTitle(dateList);
					len = dateList.length;
					var pendingLb = new Array();
    				for(var i = 0; i < len; i++){
						var dl = dateList[i];
    					var lbList = lbMap[dl];
						var tmpLb = new Array();//临时保存当天待定的数据
						var confirmLb = new Array();//临时保存当天确定的数据
						for(var j = 0; j < lbList.length; j++){//遍历每一天的数据
							var curLb = lbList[j];
							if(curLb.status == 1 && curLb.days == 1){//首板直接待定
								tmpLb.push(curLb);
							} else {//非首板
								if(i == 0){//第一列直接显示出来
									addRow(i);
									addData(i,rows,curLb);
								} else {//非第一列添加到确定列表中
									confirmLb.push(curLb);
								}
							}
						}
						if(i > 0){//非第一列
							//将前一日确定的数据展示出来
							for(var k = 0; k < confirmLb.length; k++){//今天确定的数据
								var cLb = confirmLb[k];
								if(cLb.days == 2){//今天确定的二板
									for(var j = 0; j < pendingLb.length; j++){//遍历前一日待定的首板数据
        								var pLb = pendingLb[j];
        								if(cLb.symbol == pLb.symbol){
											addRow(i-1);//添加前一日
											addData(i-1,rows,pLb);
										}
        							}
								}
							}
							//将今天确定的数据展示出来
							for(var k = 0; k < confirmLb.length; k++){
    							$("td[zb^='"+(i-1)+"']").each(function(){
									var curLb = confirmLb[k];
									if($(this).attr("s") == curLb.symbol){
										var r = $(this).attr("zb").split("_")[1];
										addData(i,r,curLb);
									}
    							});
							}
						}
						pendingLb = tmpLb;//临时待定数据存取到待定数据中
    				}
				} else {
					alert("查询失败!"+result.message);
				}
			});
			
			function showTitle(dateList){
				var len = dateList.length;
				var title = "";
				for(var i=0; i < len; i++){
					title = title + "<th>" + dateList[i] + "</th>";
				}
				$("#statis-col-name").html(title);
			}
			var rows=0;
			function addRow(colIndex){
				rows++;
				var content = "<tr>";
				for(var i=0; i < len; i++){
					content = content + "<td zb='"+i+"_"+rows+"' s=''></td>";
				}
				content += "</tr>";
				$("#statis-content").append(content);
			}
			
			function addData(col,row,curLb){
				var coord = col+"_"+row;
				var content = curLb.stockName;
				if(curLb.status == 1){//涨停
					content += "("+curLb.days+")";
				} else if(curLb.status == 2){//未涨停
					content = content + curLb.percent + "%";
				} else if(curLb.status == 3){//停牌
					content += "停牌";
				}
				$("td[zb|="+coord+"]").html(content);
				$("td[zb|="+coord+"]").attr("s", curLb.symbol);
			}
		});
		
		$('.datepicker').datepicker({format: 'yyyy-mm-dd',
            weekStart: 1,
            autoclose: true,
            todayBtn: 'linked',
            language: 'zh-CN'}).on('changeDate',function(){
				
			});
	});
</script>
